---
title: "Coverage"
author: "Sondre U. Solstad"
output: github_document
fig.caption: yes
---
#  An R package for seeing what you're missing

```{r set-options, echo=FALSE, cache=FALSE}
options(width = 150)
library(coverage)
```

The coverage package and associated function provides you with a summary of your time and unit coverage. This is important for any analysis conducted with row-wise deletion in the presence of missing data, especially if one suspect that patterns of missingness are non-random with respect to variables of interest. Examples of such analysis include standard regression analysis and most implementations of maximum likelihood. By default, the function provides a data frame of unit and time coverage ("coverage.df") and a summary of time coverage by unit ("coverage.summary"). It can also additionally supply a latex table or a visualization of coverage. Finally, the function also supports 3-dimensional data by providing total number of observations in tables, and a "heatmap" of observations in visual.

Installation instructions:
```{r, eval = FALSE}
library(devtools)
install_github("sondreus/coverage")
```


```{r, echo=FALSE}
techdata <- readRDS("3d_example.RDS")
 
coverage(timevar = "year", unitvar = "country_name",
          data = techdata,
          variable.names = c("upop", "xlrealgdp", "adoption_lvl"),
          output = "visual")

```

- *An example of row-wise coverage in technology-country-year data*

## Arguments: 

* **fit** A fitted object. Currently supports base R **lm()**.
* **timevar** - Your time variable.
* **unitvar** - Your unit variable.
* **data** - Data to be investigated. If none is supplied, defaults to data used in "**fit**" if fit is in supported format.
* **variable.names** - Variables to be checked for coverage. If none is supplied, defaults to variables used in **fit**.
* **output** - Desired output: "visual" or "latex.table". Former depends on requires the package **ggplot2**, latter requires the package **stargazer**, both available on CRAN.

## Example

Let's see how this package works through an example. We begin by getting some data from the World Bank Development Indicators, using the WDI package (by Vincent Arel-Bundock). Let's get data on GDP per capita, trade in services as a percentage of GDP, adult female literacy rates, agriculture as a percentage of GDP, and finally, number of telephone subscriptions per 1000 people.
```{r}
library("WDI", quietly = TRUE)
wdi.sample <- WDI(indicator=c('NY.GDP.PCAP.KD',
                              'BG.GSR.NFSV.GD.ZS',
                              'SE.ADT.LITR.FE.ZS',
                              'NV.AGR.TOTL.ZS',
                              'IT.TEL.TOTL.P3'),

                              country=c('MX','CA',
                              'US','TZ'),

                              start=1950, end=2012)

 colnames(wdi.sample)[4:8] <- c("GDPPC",
                                "services_gdp",
                                "literacy_women",
                                "agriculture_gdp",
                                "telephones")
```

Suppose we next are interested in how well "trade in services as a percentage of GDP" predicts "GDP per capita".

```{r}
lm.fit <- lm(GDPPC ~ services_gdp, data = wdi.sample)
summary(lm.fit)
```

So we have some data and a statistically significant relationship. But which country-years is this relationship based on? One option would be to inspect the data manually, which is viable only if the number of units (countries) and time points (years) are both small. And even in such a case, it is still very tidious. Let's instead apply the coverage function:

```{r}
library("coverage")
 coverage(fit = lm.fit, timevar = "year",
          unitvar = "country")

 coverage.summary
```

Let us also request a visual representation:
```{r}
 library("ggplot2", verbose = FALSE)
 
 coverage(fit = lm.fit, timevar = "year",
         unitvar = "country", output = "visual")
```

Or a latex table:
```{r, message=F, warning=F}
 library("stargazer", quietly = TRUE)
 coverage(fit = lm.fit, timevar = "year",
          unitvar = "country", output = "latex.table")
```

Supplying a fit is not required, and it may be easier to compare the coverage consequences of different model specifications by instead providing the variable names. This is supported in **coverage()** through the variable.names and data arguments.


Let's use this functionality to visually explore our data:

```{r}
 coverage(timevar = "year", unitvar = "country",
          data = wdi.sample,
          variable.names = c("GDPPC",
                             "agriculture_gdp"),
          output = "visual")

 # vs:
 coverage(timevar = "year", unitvar = "country",
          data = wdi.sample,
          variable.names = c("GDPPC",
          "services_gdp"),
          output = "visual")

```

## 3-Dimensional Data 

Suppose next that we have data that may have multiple observations per time and unit combination. For instance, suppose that instead of looking at country-year data, we had country-year-technology data, where data might be missing for specific technologies within a country in a specific year or for covariates at the country-year level.

```{r}
techdata <- readRDS("3d_example.RDS")

head(techdata)
 
coverage(timevar = "year", unitvar = "country_name",
          data = techdata,
          variable.names = c("upop", "xlrealgdp", "adoption_lvl"),
          output = "visual")

coverage.summary
```


## Customization

Let us return to our WDI data:
```{r} 
coverage(fit = lm.fit, timevar = "year",
         unitvar = "country", output = "visual")
```

We may have many reasons to customize this graphic. One way to do so is to ask coverage to give us the underlying code for the plot:

```{r, tidy = TRUE, tidy.opts=list(width.cutoff=60)} 
 coverage(fit = lm.fit, timevar = "year",
         unitvar = "country", visual.source = TRUE)
```

We can then manipulate this if we are not happy with the default settings:

```{r, tidy = TRUE, tidy.opts=list(width.cutoff=60)}
library(ggplot2)
base_size <- 11 # Larger text size

p <- ggplot(coverage.df, aes(Time, Unit))  
p <- p + geom_tile(aes(fill = N), colour = 'white') 
p <- p + scale_fill_gradient(low = 'white', high = 'darkgreen') # Green instead of blue 
p <- p + ggtitle(paste0("Regression Country-Year Coverage \n (N = ", sum(coverage.df$N), ")")) # Adding title
p <- p + theme_grey(base_size = base_size) # theme_bw instead of theme_grey 
p <- p + labs(x = '', y = '') # Removing axis labels 
p <- p + scale_x_discrete(expand = c(0, 0), breaks=pretty(as.numeric(as.character(coverage.df$Time)), n=25)) + scale_y_discrete(expand = c(0, 0)) # Changing number of x-axis tics
p <- p + theme(legend.position = 'none', axis.text.x = element_text(size = base_size * 0.8, angle = 320, hjust = 0, colour = 'grey50'), plot.margin = unit(c(10, 15, 10, 5), "pt"), plot.title = element_text(color="grey50", size=12)) 
# Removing legend, adjusting angle on x-axis tics 
# Increasing top and bottom margin (order of terms is top, right, bottom, left)
# Changing title color and size.
p

```




